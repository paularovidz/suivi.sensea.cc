services:
  db:
    image: mariadb:10.11
    container_name: snoezelen_db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASS}
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - snoezelen_network
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5

  api:
    image: ghcr.io/${GITHUB_REPO}-api:latest
    container_name: snoezelen_api
    restart: unless-stopped
    environment:
      DB_HOST: db
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASS: ${DB_PASS}
      DB_CHARSET: utf8mb4
      JWT_SECRET: ${JWT_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      MAIL_HOST: ${MAIL_HOST}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USER: ${MAIL_USER}
      MAIL_PASS: ${MAIL_PASS}
      MAIL_FROM: ${MAIL_FROM:-noreply@sensea.cc}
      MAIL_FROM_NAME: ${MAIL_FROM_NAME:-sensÃ«a Snoezelen}
      APP_URL: ${APP_URL:-https://suivi.sensea.cc/api}
      FRONTEND_URL: ${FRONTEND_URL:-https://suivi.sensea.cc}
      ENV: production
      DEBUG: "false"
      APP_TIMEZONE: Europe/Paris
      GOOGLE_ICAL_URL: ${GOOGLE_ICAL_URL:-}
      OVH_SMS_APP_KEY: ${OVH_SMS_APP_KEY:-}
      OVH_SMS_APP_SECRET: ${OVH_SMS_APP_SECRET:-}
      OVH_SMS_CONSUMER_KEY: ${OVH_SMS_CONSUMER_KEY:-}
      OVH_SMS_SERVICE_NAME: ${OVH_SMS_SERVICE_NAME:-}
    volumes:
      - ./api/uploads:/var/www/html/uploads
    ports:
      - "127.0.0.1:8080:80"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - snoezelen_network

  phpmyadmin:
    image: phpmyadmin:latest
    container_name: snoezelen_phpmyadmin
    restart: unless-stopped
    environment:
      PMA_HOST: db
      PMA_USER: ${DB_USER}
      PMA_PASSWORD: ${DB_PASS}
    ports:
      - "127.0.0.1:8081:80"
    depends_on:
      - db
    networks:
      - snoezelen_network

volumes:
  db_data:

networks:
  snoezelen_network:
    driver: bridge
